-- Deploy migrate/stage to pg

-- requires: migrate/meta 

-- NOTES for stage
-- 1 no uniq on schema_name
-- 2 update domains
-- 3 update apis (new dbname)
-- 4 update sites (new dbname)

BEGIN;
SET session_replication_role TO replica;
-- using replica in case we are deploying triggers to collections_public

-- unaccent, postgis affected and require grants
GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA public to public;

-- for stage, we don't need this
ALTER TABLE collections_public.schema 
    DROP CONSTRAINT IF EXISTS schema_schema_name_key;

DO $LQLMIGRATION$
  DECLARE
    prod_db_id uuid := '455a6e2c-3778-55f9-aca2-65ffa9b4a47c';
    stage_db_id uuid := '455a6e2c-3778-55f9-aca2-65ffa9b4a46d';
    stage_db_name text := 'dbe-db-staging';
    prod_db collections_public.database;
  BEGIN

    EXECUTE format('GRANT CONNECT ON DATABASE %I TO %I', current_database(), 'app_user');
    EXECUTE format('GRANT CONNECT ON DATABASE %I TO %I', current_database(), 'app_admin');

    SELECT * FROM collections_public.database
        INTO prod_db
    WHERE id = prod_db_id;

    INSERT INTO collections_public.database ( id, owner_id, name, hash ) VALUES (stage_db_id, prod_db.owner_id, prod_db.name || '-stage', prod_db.hash);

    INSERT INTO collections_public.schema ( id, database_id, name, schema_name, description ) VALUES ('07598172-db26-4108-ca37-1a961f868517', stage_db_id, 'public', 'dashboard_public', NULL), ('07591ab4-4c65-4fdd-aa20-2c44cc1888bf', stage_db_id, 'private', 'dashboard_private', NULL), ('07591e63-8673-436a-890f-2b04d746cd7a', stage_db_id, 'memberships_public', 'dashboard_memberships_public', NULL), ('075926b0-5f8c-4007-3d56-44bff490bd43', stage_db_id, 'permissions_public', 'dashboard_permissions_public', NULL), ('0759ba7b-1e8f-43ba-b55c-f0ef1aaeb910', stage_db_id, 'permissions_private', 'dashboard_permissions_private', NULL), ('0759a226-c9c8-4c0b-1303-9aa05bba5d1a', stage_db_id, 'limits_public', 'dashboard_limits_public', NULL), ('075949d1-f1e4-4373-77c9-0f9d38dbfb62', stage_db_id, 'limits_private', 'dashboard_limits_private', NULL), ('075956ad-8c2c-4552-041b-a9c379eb1bc6', stage_db_id, 'memberships_private', 'dashboard_memberships_private', NULL), ('0759a191-af9a-4728-56c3-741bd8f88f71', stage_db_id, 'status_public', 'dashboard_status_public', NULL), ('075906d5-b4bb-4ba1-63bb-0f0e63310475', stage_db_id, 'status_private', 'dashboard_status_private', NULL), ('0759594e-09b5-4a01-6d8f-911fa292874d', stage_db_id, 'simple_secrets', 'dashboard_simple_secrets', NULL), ('0759296a-5299-460a-499c-b70a0101cc01', stage_db_id, 'roles_private', 'dashboard_roles_private', NULL), ('0759f438-54f4-41f9-b308-a17fc8befd86', stage_db_id, 'encrypted', 'dashboard_encrypted', NULL), ('07599040-1fee-461e-a42c-8bc1dba01d7b', stage_db_id, 'roles_public', 'dashboard_roles_public', NULL), ('0759e74f-0411-4c22-b3e6-e35e47d9052c', stage_db_id, 'invites_public', 'dashboard_invites_public', NULL), ('07597569-fc25-4671-d039-cfc3ff000a62', stage_db_id, 'invites_private', 'dashboard_invites_private', NULL);

    INSERT INTO collections_public."table" ( id, database_id, schema_id, name, description ) VALUES ('0759a72e-4f2b-4e77-1060-39af1e6e9278', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'role_types', NULL), ('07599196-5f23-4c0d-1f3a-fe7719f13a80', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'users', NULL), ('07591ede-c353-465c-e147-30e9b56e1d6e', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'membership_types', NULL), ('0759f657-8658-4d4a-38cb-8f8bb520a84d', stage_db_id, '075956ad-8c2c-4552-041b-a9c379eb1bc6', 'app_memberships_acl', NULL), ('0759a715-11d7-48a3-212e-0654b12c5b9b', stage_db_id, '075956ad-8c2c-4552-041b-a9c379eb1bc6', 'memberships_acl', NULL), ('0759365f-915e-46e3-a460-3ae51dd277c0', stage_db_id, '075956ad-8c2c-4552-041b-a9c379eb1bc6', 'group_memberships_acl', NULL), ('0759cd4a-fda3-4a4d-10a5-1b7e61ec2d5c', stage_db_id, '0759594e-09b5-4a01-6d8f-911fa292874d', 'user_secrets', NULL), ('0759f212-a2aa-449b-ae6f-4d69116e53d0', stage_db_id, '0759296a-5299-460a-499c-b70a0101cc01', 'api_tokens', NULL), ('07591c8d-e598-4c47-3f4d-b8f3fd16c919', stage_db_id, '0759f438-54f4-41f9-b308-a17fc8befd86', 'user_encrypted_secrets', NULL), ('0759405e-178a-4a71-7302-d1e075451132', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'connected_accounts', NULL), ('07599d70-af02-4f0d-0510-826b402f86d0', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'emails', NULL), ('07590119-01a5-4a7c-bd1a-e5da0d1bde4b', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'phone_numbers', NULL), ('0759c2f8-9cb4-4d64-388c-d2b22e97c060', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'crypto_addresses', NULL), ('07597240-d376-4998-e3d1-3893ce68a739', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'invites', NULL), ('07599fa0-183c-44f8-0f14-d0e3fc11da1a', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'claimed_invites', NULL), ('0759a01b-a8d4-4ad1-2ce8-5c9a32b95456', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'member_invites', NULL), ('0759ad7b-c803-44f4-15a5-adcbb1585bda', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'member_claimed_invites', NULL), ('0759aa4d-4016-448d-56c9-d75ffb549482', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'group_invites', NULL), ('07597fee-0c30-41ce-e0ff-ec8beb9d2449', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'group_claimed_invites', NULL), ('0759bb8a-280b-4716-b53a-63540f0bffe5', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'app_permissions', NULL), ('0759347c-b2b3-4cde-b21c-133cd7f4c9f2', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'app_permission_defaults', NULL), ('0759ade5-e1b4-41c1-36d4-b9bb0b37f14e', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'app_limits', NULL), ('07591903-d226-4592-8ffd-50aa1574a9b8', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'app_limit_defaults', NULL), ('075965ad-9b32-41ba-0087-ab4093b74e34', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'app_memberships', NULL), ('07591a0a-0357-4ccf-a7f4-286e38f1fba8', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'app_membership_defaults', NULL), ('0759e798-d763-4c5a-6927-5cf03fc8b483', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'app_grants', NULL), ('075950d9-230d-4aef-41e0-6b815fb5eae0', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'app_admin_grants', NULL), ('07595acc-c291-4764-a5ab-d7a5e7281fa8', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'app_owner_grants', NULL), ('07594582-186e-4fb9-d93a-d771227fc7d4', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', 'app_steps', 'The user achieving a requirement for a level. Log table that has every single step ever taken.'), ('0759d201-8b1c-4126-2d19-6ec942702ae4', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', 'app_achievements', 'This table represents the users progress for particular level requirements, tallying the total count. This table is updated via triggers and should not be updated maually.'), ('07593b36-487f-488e-aea6-e6f9cacef64d', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', 'app_levels', 'Levels for achievement'), ('0759f149-c56e-4720-81f7-0621b46423d2', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', 'app_level_requirements', 'Requirements to achieve a level'), ('075956f7-7eb4-4f3d-4923-5a5bbf5897ca', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'membership_permissions', NULL), ('075973d5-dcdb-4dc3-4486-ab8e3e633391', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'membership_permission_defaults', NULL), ('075962d8-3c6b-4d12-1fa7-7536782a4f68', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'membership_limits', NULL), ('0759afc2-1b1d-4022-5a75-f967c44dacee', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'membership_limit_defaults', NULL), ('07595255-ec3c-4f6a-7069-cd47c798f4b2', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'members', NULL), ('075963c4-fbb4-4713-d84e-6973827f76df', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'memberships', NULL), ('0759296a-7f72-4ef7-f749-9e4bdd6bb946', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'membership_defaults', NULL), ('0759d6f5-6a22-456a-f5d6-76bf84225b3a', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'grants', NULL), ('0759d9b2-7594-4459-55ab-f9ebeb9bedaa', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'admin_grants', NULL), ('075987e7-eb7b-4666-5b15-dce7b1cefad0', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'owner_grants', NULL), ('0759bd69-7250-44f0-28ce-be9ad76debda', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'groups', NULL), ('0759f134-872a-4bd0-691c-71f3da68299c', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'group_member_permissions', NULL), ('07596990-3a84-4320-44cf-47d4afe68f98', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'group_member_permission_defaults', NULL), ('075901d1-16ed-402e-e2b2-8a11ccd51794', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'group_member_limits', NULL), ('07593431-48f6-46b5-5a8f-0dd3269340c7', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'group_member_limit_defaults', NULL), ('0759293e-bd60-4ede-1c6c-83d594f7fe68', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'group_members', NULL), ('0759009b-cadb-49d7-7710-fd47b2b0c463', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'group_memberships', NULL), ('0759433a-ffe0-4c8c-993f-c54f7355fe44', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'group_membership_defaults', NULL), ('0759c37d-3220-4b44-ada3-dc756a4ea11b', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'group_grants', NULL), ('0759d0f2-ee74-440d-5463-545bfd28adab', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'group_admin_grants', NULL), ('07598c4c-f2ce-4539-5217-7d5f461958ac', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'group_owner_grants', NULL), ('0759d8f6-2da0-412f-68a9-d02e31fc9201', stage_db_id, '07599040-1fee-461e-a42c-8bc1dba01d7b', 'audit_logs', NULL), ('0759326a-1a75-4a6c-3a99-3a7563c7072a', stage_db_id, '07599040-1fee-461e-a42c-8bc1dba01d7b', 'auth_accounts', NULL), ('07595f9d-fdfe-4bfd-20ef-c61209ae4a9d', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_profiles', NULL), ('07598e9a-c36d-44c1-cbe8-4977b93e4313', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_settings', NULL), ('07594d91-40d3-40a7-461a-b8a0baf8ced7', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_characteristics', NULL), ('0759b3ea-d14b-4ec8-9de3-ad49efe5c000', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_contacts', NULL), ('0759e2c6-9cc8-4a79-4acf-e3020ec28460', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_connections', NULL), ('0759a4c9-4daa-4103-df43-5e18eb0b24d0', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'location_types', NULL), ('0759eae8-4784-40f6-6aeb-c7c205ceb207', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'locations', NULL), ('07594be7-081a-4b10-d6ee-3e03a2f63229', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_locations', NULL), ('0759a767-28ea-4fdb-3c33-33f67dfca416', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'news_articles', NULL), ('0759629b-75dd-4653-796b-5e5867bd8a4e', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'quantities', NULL), ('075943da-1b73-47f3-8198-06b384e2c789', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'units', NULL), ('0759cdb8-0839-43af-a6fb-3d54dea58597', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'object_types', NULL), ('0759b36c-ddd7-4ccb-7afd-5e1c3eb14dd7', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'objects', NULL), ('075959e2-0795-498b-4a5e-af86bdf53143', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'object_type_attributes', NULL), ('0759c64a-53c5-4158-af2d-d794df4356ee', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'object_type_values', NULL), ('0759a4fc-b9ef-472f-cdfc-a4f25e115eb8', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'object_attributes', NULL), ('0759e619-51be-4e15-d5d4-fcb155049b83', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'object_records', NULL), ('0759feb5-7f66-4ed3-3ba8-fbe280423095', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'impacts', NULL), ('0759b4d9-896b-4fba-822d-65155c6ec596', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'impacts_conditions', NULL), ('0759a11c-9d3e-4ebd-3c93-3ac2a375c526', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'goals', NULL), ('075973d5-1572-4589-3a2c-a8085fc5432e', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'goal_explanations', NULL), ('0759365a-9071-4e75-f1ab-7766e1f3fa90', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'actions', NULL), ('0759b558-9142-4ea9-d2ec-e7e0f7dface6', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_goals', NULL), ('0759a363-a487-46bf-e6df-a5b06cf49fa0', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_variations', NULL), ('0759791d-bb79-49fb-fb0e-c56d0c197834', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_item_types', NULL), ('075968a7-6abb-49f0-7bc7-72cf25fc16b4', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_items', NULL), ('0759cc5c-9040-4091-07d5-5e768327fe43', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'related_actions', NULL), ('0759d7f2-1d7c-4bb6-4060-fd4a40ee1b3c', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_locations', NULL), ('0759f252-80b3-4c2e-d078-53adec2fefea', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_actions', NULL), ('075968ca-2ef0-4f34-0c67-8b3308601773', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_action_verifications', NULL), ('0759bbce-a71b-48dc-0074-c3af0bbb0b16', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_action_items', NULL), ('0759ffdc-d74e-4c06-20b6-0cf6e478af98', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_action_item_verifications', NULL), ('0759e96c-f6e3-49bc-d824-42e06be7253e', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'tracks', NULL), ('07592930-510c-434a-e650-959f8d9f00b9', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'track_actions', NULL), ('07598f01-4bcf-45ab-f100-3f9a27422671', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_tracks', NULL), ('0759871a-3d55-4557-d53f-85c0dcb35f53', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_impacts', NULL), ('0759d541-9957-4267-f5a0-f2173c22d2b7', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'zip_codes', NULL), ('075966dc-1f46-49fc-0920-91725b5b7951', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'tags', NULL), ('0759d8a9-5c63-42ad-8fbe-2145bba1c134', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'organization_profiles', NULL), ('07599e29-baa5-4471-1387-ef497803a911', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_pass_actions', NULL), ('07599152-41c3-457a-f16d-ab0debec80c2', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_saved_actions', NULL), ('075936c3-f5b2-46cd-61a2-b53b529b0485', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_viewed_actions', NULL), ('07593b04-004b-4362-ce94-f886c4f1da4a', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_action_reactions', NULL), ('0759a993-afdf-4109-f1b4-1af17c072315', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_messages', NULL), ('07595b3b-2d5b-4f89-bc7d-1166954ee3f5', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'message_groups', NULL), ('075903a2-a58b-46a3-ce32-4b17e8b8db20', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'messages', NULL), ('07598a18-2f79-49f0-8b1b-ca0fb8313169', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'posts', NULL), ('0759cce9-f294-4c33-2fd3-8bb91d259a9a', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'post_reactions', NULL), ('07593e80-65de-4741-7af3-f58ebe7d980b', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'post_comments', NULL), ('07592be8-08a5-43a0-eec1-b2b903afe208', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'group_posts', NULL), ('07590442-2cd7-4c87-ed7f-dbfdc55d81d5', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'group_post_reactions', NULL), ('07596d4d-af62-46bf-8354-6c6c58940386', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'group_post_comments', NULL), ('07591aaf-4ba3-46ef-b482-914411431dd0', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'group_locations', NULL), ('075946af-07bc-4828-8e18-e6cb8186b689', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'group_goals', NULL), ('0759bab2-998c-4fec-e866-08ed86848538', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_devices', NULL), ('07594e13-fa15-4481-5677-edb538653298', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'notifications', NULL), ('07592577-8281-48dd-cf45-9d4ba995431d', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'notification_preferences', NULL), ('07598e0b-d29e-47c2-2b0d-34e6156d3efe', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'question_templates', NULL), ('0759f8d9-8a24-478d-2ab2-515c9c0e7529', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_questions', NULL), ('075964f0-764a-4261-317e-23b7b1c1233d', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'user_answers', NULL), ('07590d1c-965a-4d60-c0d5-b71fbec65244', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'action_questions', NULL), ('0759f295-4e08-4139-b169-b575dcec41e8', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'onboarding_questions', NULL), ('07592b74-b4bb-459f-398e-c4aa98d7cb6e', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'rewards', NULL), ('0759931f-aaf2-4523-4060-a5cf4742d348', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'reward_payments', NULL);

    INSERT INTO meta_public.domains ( id, database_id, site_id, api_id, domain, subdomain ) VALUES
        ('52e9ba44-74d1-4c38-b84a-dffc09fbd785', stage_db_id, NULL, 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d', 'dbe.la', 'api.stage'),
        ('11219e4c-a040-496a-86d2-ee0b11e273ee', stage_db_id, NULL, '2e113c8c-f5e3-436d-abbf-3965c5227266', 'dbe.la', 'admin.stage'),
        ('3545293a-1cde-4161-a8b9-58070ae0002d', stage_db_id, NULL, '809116d6-9ab4-4e04-ab9f-acd7feb5c6f5', 'dbe.la', 'meta.stage'),
        ('4680c366-f57b-4d32-b82e-a328965963c0', stage_db_id, '86f3de62-e48f-4f93-a1a5-e8f5b4236d01', NULL, 'dbe.la', 'app.stage');

    INSERT INTO meta_public.apis ( id, database_id, name, dbname, is_public, role_name, anon_role ) VALUES
        ('c8927a52-6fdd-48ea-ac13-b00c0fea0b9d', stage_db_id, 'public', stage_db_name, TRUE, 'authenticated', 'anonymous'),
        ('903fae7b-8340-4e6d-85ed-def62616164c', stage_db_id, 'private', stage_db_name, FALSE, 'administrator', 'administrator'),
        ('2e113c8c-f5e3-436d-abbf-3965c5227266', stage_db_id, 'admin', stage_db_name, TRUE, 'administrator', 'administrator'),
        ('809116d6-9ab4-4e04-ab9f-acd7feb5c6f5', stage_db_id, 'meta', stage_db_name, FALSE, 'administrator', 'administrator'),
        ('bfb267ef-4ab2-43bc-8cb9-1db5e7e399ce', stage_db_id, 'jobs', stage_db_name, FALSE, 'administrator', 'administrator');

    INSERT INTO meta_public.sites ( id, database_id, title, description, og_image, favicon, apple_touch_icon, logo, dbname ) VALUES
        ('86f3de62-e48f-4f93-a1a5-e8f5b4236d01', stage_db_id, 'Dashboard Earth', 'Download our app to get the solutions necessary to balance the climate', '{"url":"https://dl.airtable.com/.attachments/47f723ee5ea33d20e03eb7a82fdd74ea/64497b4d/dbe.png","mime":"image/png"}', 'https://dl.airtable.com/.attachments/9d08e1a8ccfb4e250980e91776707f7e/8057a765/favicon.ico', '{"url":"https://dl.airtable.com/.attachments/1d46c02b389e9902b7b70f50a4bec2e8/602c5ec6/logo-192x192.png","mime":"image/png"}', '{"url":"https://dl.airtable.com/.attachments/47f723ee5ea33d20e03eb7a82fdd74ea/64497b4d/dbe.png","mime":"image/png"}',
    stage_db_name);

    INSERT INTO meta_public.api_modules ( id, database_id, api_id, name, data ) VALUES ('ecd01687-841c-43df-8f29-9c963c100e8f', stage_db_id, 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d', 'rls_module', '{"role_schema":"dashboard_roles_public","authenticate":"authenticate","current_role":"get_current_user","current_role_id":"get_current_user_id","current_ip_address":"current_ip_address","current_user_agent":"current_user_agent","authenticate_schema":"dashboard_roles_private","authenticate_strict":"authenticate_strict"}');

    INSERT INTO meta_public.site_modules ( id, database_id, site_id, name, data ) VALUES ('41e58eef-15bc-4044-a390-ad42a6524457', stage_db_id, '86f3de62-e48f-4f93-a1a5-e8f5b4236d01', 'legal_terms_module', '{"site":{"www":"app.dbe.la","host":"app.dbe.la","siteUrl":"https://app.dbe.la"},"emails":{"abuse":"info@dashboard.earth","hello":"info@dashboard.earth","legal":"info@dashboard.earth","privacy":"info@dashboard.earth","support":"info@dashboard.earth","copyright":"info@dashboard.earth","arbitrationOptOut":"info@dashboard.earth"},"company":{"addr":["2326 Penmar Ave.","Los Angeles, CA 90291"],"name":"Dashboard Earth, Inc.","nick":"Dashboard Earth","website":"http://dashboard.earth/","legalState":"California","legalCounty":"Los Angeles"}}'), ('4a36adba-cbd8-4535-b914-8cbf31d775ca', stage_db_id, '86f3de62-e48f-4f93-a1a5-e8f5b4236d01', 'user_auth_module', '{"sign_in":"login","sign_up":"register","sign_out":"logout","auth_schema":"dashboard_roles_public","set_password":"set_password","verify_email":"verify_email","check_password":"check_password","reset_password":"reset_password","forgot_password":"forgot_password","verify_password":"verify_password","send_verification_email":"send_verification_email"}');

    INSERT INTO meta_public.site_themes ( id, database_id, site_id, theme ) VALUES ('097e4369-e55b-4220-8710-d88e36695a7c', stage_db_id, '86f3de62-e48f-4f93-a1a5-e8f5b4236d01', '{"colors":["#9DB4B2","#d3e3e3","#766543","#263130"],"primary":"#466968","background":"#f0f4f4"}');

    INSERT INTO meta_public.apps ( id, database_id, site_id, name, app_image, app_store_link, app_store_id, app_id_prefix, play_store_link ) VALUES ('365e2645-10c4-4c35-94e7-4513fc8c1c09', stage_db_id, '86f3de62-e48f-4f93-a1a5-e8f5b4236d01', 'Dashboard Earth', '{"url":"https://dl.airtable.com/.attachments/b5633bad81def88c8d1d93146b1d8da8/f5795056/earth.png","mime":"image/png"}', 'https://itunes.apple.com/us/app/dashboard-earth/id1444355623', '1444355623', NULL, NULL);

    INSERT INTO meta_public.api_extensions ( id, database_id, api_id, schema_name ) VALUES ('a5db1f76-85fc-4dae-8f04-4710450cbebe', stage_db_id, '809116d6-9ab4-4e04-ab9f-acd7feb5c6f5', 'meta_public'), ('39e31894-770f-4e79-ae33-f7acf0d1ae4c', stage_db_id, '809116d6-9ab4-4e04-ab9f-acd7feb5c6f5', 'collections_public'), ('ee671fda-c897-46a2-bca3-3e013ad3737f', stage_db_id, 'bfb267ef-4ab2-43bc-8cb9-1db5e7e399ce', 'app_jobs');

    INSERT INTO meta_public.api_schemata ( id, database_id, schema_id, api_id ) VALUES ('6b3bf744-0045-4043-8c04-bd078c53ddad', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('96ee1447-1ba1-46e7-81f9-ae530b3cf0cb', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', '903fae7b-8340-4e6d-85ed-def62616164c'), ('ee0b66f1-bc9a-4f6e-a4c7-7f3e40e81416', stage_db_id, '07591ab4-4c65-4fdd-aa20-2c44cc1888bf', '903fae7b-8340-4e6d-85ed-def62616164c'), ('f932dcd7-9215-4faa-82fb-907d5e9033ac', stage_db_id, '07598172-db26-4108-ca37-1a961f868517', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('42588825-151d-49cc-8d8d-fe088a829bf6', stage_db_id, '07591ab4-4c65-4fdd-aa20-2c44cc1888bf', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('4fafedd9-f585-4dd7-a120-6654f49a1ead', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('8f69ea88-e22e-4b52-ae77-8444cc9d3b19', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', '903fae7b-8340-4e6d-85ed-def62616164c'), ('fefbcd41-2b82-4737-bdbb-cf4c1084f5bf', stage_db_id, '075926b0-5f8c-4007-3d56-44bff490bd43', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('aa25cbce-bf3a-449a-82c0-bb7ce4f00d16', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('38aae9a2-c42b-462b-bc5a-67689e4916b5', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', '903fae7b-8340-4e6d-85ed-def62616164c'), ('495a7fca-ab89-4e27-8daa-d423905c4205', stage_db_id, '0759a226-c9c8-4c0b-1303-9aa05bba5d1a', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('c889ab29-be47-454a-9eec-09a8cef0d2fb', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('07c7b14a-e3ff-4ee5-9ad7-c94513a087e9', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', '903fae7b-8340-4e6d-85ed-def62616164c'), ('18e03bbb-3d90-47e3-ae69-d26d602613f3', stage_db_id, '07591e63-8673-436a-890f-2b04d746cd7a', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('1829d92e-86a8-4157-8c6c-ad67573aeafe', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('5b3c6b84-02c4-41e5-bc65-ca222735a5f9', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', '903fae7b-8340-4e6d-85ed-def62616164c'), ('55d9cd59-bb42-460a-845f-fd027be244ec', stage_db_id, '0759a191-af9a-4728-56c3-741bd8f88f71', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('80c2d9b5-d0b1-4b94-924e-e07558b213f5', stage_db_id, '07599040-1fee-461e-a42c-8bc1dba01d7b', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('d7c9bfeb-ebae-421b-bb2c-e8fc004a569e', stage_db_id, '07599040-1fee-461e-a42c-8bc1dba01d7b', '2e113c8c-f5e3-436d-abbf-3965c5227266'), ('1c3fc84d-c602-4e57-ac4b-38bff9badaef', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d'), ('1a067f5d-05f0-4f80-a1f1-4959857faedc', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', '903fae7b-8340-4e6d-85ed-def62616164c'), ('a168670e-42d1-4e29-8a3c-97e263d9e1b7', stage_db_id, '0759e74f-0411-4c22-b3e6-e35e47d9052c', '2e113c8c-f5e3-436d-abbf-3965c5227266');

    INSERT INTO meta_public.rls_module ( id, database_id, api_id, schema_id, private_schema_id, tokens_table_id, users_table_id, authenticate, authenticate_strict, "current_role", current_role_id ) VALUES ('be7c9fe8-9161-4e11-9de8-ede364b9ac92', stage_db_id, 'c8927a52-6fdd-48ea-ac13-b00c0fea0b9d', '07599040-1fee-461e-a42c-8bc1dba01d7b', '0759296a-5299-460a-499c-b70a0101cc01', '0759f212-a2aa-449b-ae6f-4d69116e53d0', '07599196-5f23-4c0d-1f3a-fe7719f13a80', 'authenticate', 'authenticate_strict', 'get_current_user', 'get_current_user_id');

    INSERT INTO meta_public.user_auth_module ( id, database_id, schema_id, emails_table_id, users_table_id, secrets_table_id, encrypted_table_id, tokens_table_id, sign_in_function, sign_up_function, sign_out_function, sign_in_one_time_token_function, one_time_token_function, extend_token_expires, send_account_deletion_email_function, delete_account_function, set_password_function, reset_password_function, forgot_password_function, send_verification_email_function, verify_email_function ) VALUES ('5b680a77-37e0-4f3b-aee1-03fd087ab8f5', stage_db_id, '07599040-1fee-461e-a42c-8bc1dba01d7b', '07599d70-af02-4f0d-0510-826b402f86d0', '07599196-5f23-4c0d-1f3a-fe7719f13a80', '0759cd4a-fda3-4a4d-10a5-1b7e61ec2d5c', '07591c8d-e598-4c47-3f4d-b8f3fd16c919', '0759f212-a2aa-449b-ae6f-4d69116e53d0', 'login', 'register', 'logout', 'login_one_time_token', 'one_time_token', 'extend_token_expires', 'send_account_deletion_email', 'confirm_delete_account', 'set_password', 'reset_password', 'forgot_password', 'send_verification_email', 'verify_email');

    -- UPDATE meta_public.apis
    --       SET dbname = current_database() WHERE TRUE;

    -- UPDATE meta_public.sites
    --       SET dbname = current_database() WHERE TRUE;

  END;
$LQLMIGRATION$;


SET session_replication_role TO DEFAULT;

COMMIT;
